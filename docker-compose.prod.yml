version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_DB: ${POSTGRES_DB:-kevinalthaus}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      # NODE_ENV used by init script (00-setup-ssl.sh) to enforce SSL in production
      NODE_ENV: production
      POSTGRES_USE_SSL: "true"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_backups:/backups
      - ./docker/postgres/init:/docker-entrypoint-initdb.d:ro
      - ./docker/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./docker/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ./docker/postgres/docker-entrypoint-wrapper.sh:/docker-entrypoint-wrapper.sh:ro
      # IMPORTANT: SSL certificates must exist before container startup
      # See docs/security.md for certificate generation and placement instructions
      # Required files: ./secrets/server.crt and ./secrets/server.key
      - ./secrets/server.crt:/etc/ssl/certs/server.crt
      - ./secrets/server.key:/etc/ssl/private/server.key
    entrypoint: ["/bin/sh", "-c", "/docker-entrypoint-wrapper.sh postgres -c config_file=/etc/postgresql/postgresql.conf -c hba_file=/etc/postgresql/pg_hba.conf"]
    secrets:
      - postgres_password
    healthcheck:
      test: 'pg_isready -U $${POSTGRES_USER:-postgres} -d $${POSTGRES_DB:-kevinalthaus}'
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - app_network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    security_opt:
      - no-new-privileges:true

  api-gateway:
    build:
      context: .
      dockerfile: docker/api-gateway/Dockerfile
    ports:
      - '4000:3000'
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app_network
    restart: always
    environment:
      NODE_ENV: production
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required for api-gateway}
      INTERNAL_GATEWAY_TOKEN: ${INTERNAL_GATEWAY_TOKEN:?INTERNAL_GATEWAY_TOKEN is required for api-gateway}
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:3000/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - /app/node_modules
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  main-app:
    build:
      context: .
      dockerfile: docker/main-app/Dockerfile
    # Port mapping removed for security - main-app is only accessible via api-gateway
    # This prevents direct access and header spoofing attacks
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app_network
    restart: always
    environment:
      NODE_ENV: production
      MAIN_APP_PORT: 3001
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required for main-app}
      FINGERPRINT_SECRET: ${FINGERPRINT_SECRET:?FINGERPRINT_SECRET is required for main-app}
      CSRF_SECRET: ${CSRF_SECRET:?CSRF_SECRET is required for main-app}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:?ENCRYPTION_KEY is required for main-app}
      PLUGIN_SIGNATURE_SECRET: ${PLUGIN_SIGNATURE_SECRET:?PLUGIN_SIGNATURE_SECRET is required for main-app}
      SESSION_SECRET: ${SESSION_SECRET:?SESSION_SECRET is required for main-app}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-kevinalthaus}
      # TLS/SSL Configuration: verify-full enforces encrypted connections and certificate validation
      # CA certificate must exist at ./secrets/ca.crt on the host and is mounted to /run/secrets/postgres_ca via Docker secrets
      # For self-signed setups, copy ./secrets/server.crt to ./secrets/ca.crt so the client can trust the server cert
      PGSSLMODE: verify-full
      # DATABASE_URL uses POSTGRES_PASSWORD_FILE secret - application must read /run/secrets/postgres_password and construct the connection string
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      PGSSLROOTCERT: /run/secrets/postgres_ca
      INTERNAL_GATEWAY_TOKEN: ${INTERNAL_GATEWAY_TOKEN:?INTERNAL_GATEWAY_TOKEN is required for main-app}
    secrets:
      - postgres_password
      - postgres_ca
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:3001/health || exit 1']
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 40s
    volumes:
      # Use bind mounts for file storage to persist data
      - ./uploads:/app/uploads
      - ./uploads_quarantine:/app/packages/main-app/uploads_quarantine
      - ./storage:/app/storage
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G

  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
    ports:
      - '3002:3000'
    networks:
      - app_network
    restart: always
    environment:
      NODE_ENV: production
    volumes:
      - /app/node_modules
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  admin:
    build:
      context: .
      dockerfile: docker/admin/Dockerfile
    ports:
      - '3003:3000'
    networks:
      - app_network
    restart: always
    environment:
      NODE_ENV: production
    volumes:
      - /app/node_modules
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

networks:
  app_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  postgres_data:
    driver: local
  postgres_backups:
    driver: local

secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
  postgres_ca:
    file: ./secrets/ca.crt
