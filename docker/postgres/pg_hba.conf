# PostgreSQL Client Authentication Configuration File
# ===================================================
#
# This file controls: which hosts are allowed to connect, how clients
# are authenticated, which PostgreSQL user names they can use, which
# databases they can access.
#
# TYPE  DATABASE        USER            ADDRESS                 METHOD
#
# TYPE can be "local", "host", "hostssl", or "hostnossl"
# DATABASE can be "all", "sameuser", "samerole", "replication", a database name, or a comma-separated list
# USER can be "all", a user name, a group name prefixed with "+", or a comma-separated list
# ADDRESS specifies the set of hosts the record matches (IP address range or hostname)
# METHOD can be "trust", "reject", "md5", "password", "scram-sha-256", "peer", "ident", etc.
#
# SECURITY: Use scram-sha-256 for all password authentication in production
# ===================================================

# Local connections (Unix domain socket)
# Allow postgres superuser to connect via peer authentication
local   all             postgres                                peer

# Local Unix socket connections
local   all             all                                     scram-sha-256

# IPv4 connections from Docker network
# Docker default bridge network range (restricted to /24 subnet)
# Use dedicated least-privilege application user (kevinalthaus_app) instead of superuser
# Create this user with: CREATE USER kevinalthaus_app WITH PASSWORD 'your_password';
#                        GRANT CONNECT ON DATABASE kevinalthaus TO kevinalthaus_app;
#                        GRANT USAGE ON SCHEMA public TO kevinalthaus_app;
#                        GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO kevinalthaus_app;
#                        ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO kevinalthaus_app;
hostssl kevinalthaus    kevinalthaus_app        172.17.0.0/24           scram-sha-256

# Custom Docker network (from docker-compose.prod.yml)
# Production network requires SSL/TLS connections only
# Restricted to /24 subnet and specific database/user for least privilege
hostssl kevinalthaus    kevinalthaus_app        172.28.0.0/24           scram-sha-256

# IPv4 localhost connections
host    all             all             127.0.0.1/32            scram-sha-256

# IPv6 localhost connections
host    all             all             ::1/128                 scram-sha-256

# Replication connections (if setting up replication)
# local   replication     all                                     peer
# host    replication     all             127.0.0.1/32            scram-sha-256
# host    replication     all             ::1/128                 scram-sha-256

# Deny all other connections
# This is implicit, but shown here for clarity
# host    all             all             0.0.0.0/0               reject
# host    all             all             ::/0                    reject

# ===================================================
# NOTES:
# ===================================================
# 1. Order matters - first matching rule is used
# 2. Reload configuration (choose one):
#    - SQL method: docker exec kevinalthaus-postgres psql -U postgres -c "SELECT pg_reload_conf();"
#    - pg_ctl with data dir: docker exec kevinalthaus-postgres pg_ctl reload -D "$PGDATA"
# 3. Test connections: psql -h localhost -U postgres -d kevinalthaus
# 4. For production, restrict to known IP ranges only
# 5. Monitor failed authentication attempts in PostgreSQL logs
# ===================================================
